<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriKA</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Josefin Sans'>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href='https://fonts.googleapis.com/css?family=Source Sans Pro' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" />
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" />
    <!-- Font Awesome or other libraries -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" />
    <!-- Custom Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <!-- jQuery(-->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>


</head>
<body>
    <!-- Main Container -->
    <div id="container">
        <!-- Navigation Bar -->
        <nav>
            <div class="nav-container">
              <!-- Logo Section -->
              <div class="nav-logo">
                <a href="{{ url_for('home') }}">
                  <img src="{{ url_for('static', filename='images/AgriKA.png') }}" alt="Logo">
                </a>
              </div>
              <!-- Navigation Links -->
              <ul class="nav-links">
                <li>
                  <a href="{{ url_for('home') }}">
                    <span class="nav-label">HOME</span>
                  </a>
                </li>
                <li>
                  <a href="{{ url_for('view') }}">
                    <span class="nav-label">YIELD DATA</span>
                  </a>
                </li>
              </ul>
            </div>
        </nav>
        
        <!-- Sidebar Container -->
        <div id="sidebar-container">
            <!-- Sidebar Top: Toggle Buttons for Real-Time / Historical Views -->
            <div id="sidebar-top-container">
                <button id="realtime-btn" class="hist-toggle-btn realtime-btn active">Real-Time</button>
                <button id="historical-btn" class="hist-toggle-btn realtime-btn">Historical</button>
            </div>

            <!-- Sidebar Content -->
            <div id="sidebar">
                <!-- Real-Time Content Section -->
                <div id="realtime-content">
                    <div id="toggle-container">
                        <!-- Graph Toggle Dropdown for Real-Time View -->
                        <select id="graph-toggle-dropdown">
                            <option value="bar">Bar Graph</option>
                            <option value="table">Table</option>
                        </select>
                        <!-- Sort Dropdown for Real-Time View -->
                        <select id="sort-dropdown">
                            <option value="" disabled selected>Sort Here</option>
                            <option value="asc">Low to High</option>
                            <option value="desc">High to Low</option>
                            <option value="default">Default</option>
                        </select>

                        <!-- Municipality Search for Real time -->
                        <div class="dropdown-container" style="display: none;">
                            <input type="text" style="display: none;" id="municipality-search" placeholder="Select municipality" onfocus="showDropdown()" oninput="filterDropdown()" onkeydown="navigateDropdown(event)" autocomplete="off" >
                            <span style="display: none;" id="clear-search" onclick="clearSearch()">❌</span>
                            <div  style="display: none;" id="municipality-dropdown" class="dropdown-content"></div>
                        </div>

                        
                    </div>
                    <!-- Bar Chart Container for Real-Time Data -->
                    <div id="bar-chart-container">
                        <canvas id="bar-chart"></canvas>
                    </div>
                    <!-- Yield Table Container for Real-Time Data (initially hidden) -->
                    <div id="yield-table-container" style="display: none;">
                        <table id="data-table" class="styled-table data-table">
                           <thead>
                                <tr>
                                    <th>Municipality</th>
                                    <th>Yield (t/ha)</th>
                                </tr>
                           </thead>
                           <tbody>
                                {% for row in realtime_yield_data %}
                                <tr>
                                    <td>{{ row.municipality }}</td>
                                    <td>{{ row.yield }}</td>
                                </tr>
                                {% endfor %}
                           </tbody>
                        </table>
                      </div>
                </div>

                <!-- Historical Content Section (initially hidden) -->
                <div id="historical-content" style="display: none;">
                    <div id="toggle-container-his">
                        <!-- Municipality Search for Historical -->
                        <div class="dropdown-container-his">
                            <input type="text" id="municipality-search-his" placeholder="Select municipality" autocomplete="off" >
                            <span id="clear-search-his">❌</span>
                            <div class="dropdown-wrapper">
                                <div id="municipality-dropdown-his" class="dropdown-list"></div>
                            </div>
                        </div>
                    </div>
                    <div id="toggle-container-his">
                        <!-- Graph Toggle Dropdown for Historical View -->
                        <select id="graph-toggle-dropdown-his">
                            <option value="bar">Bar Graph</option>
                            <option value="table">Table</option>
                        </select>

                        <!-- Sort Toggle Dropdown for Historical View -->
                        <select id="sort-dropdown-his">
                            <option value="" disabled selected>Sort Here</option>
                            <option value="asc">Low to High</option>
                            <option value="desc">High to Low</option>
                            <option value="default">Default</option>
                        </select>

                        <!-- Year Selection Dropdown -->
                        <select id="year-dropdown-his">
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                            <option value="2019">2019</option>
                            <option value="2018">2018</option>
                        </select>

                        <!-- Season Selection Dropdown -->
                        <select id="season-dropdown-his">
                            <option value="season1">Season 1</option>
                            <option value="season2">Season 2</option>
                        </select>
                    </div>
                    
                    <!-- Bar Chart Container for Historical Data -->
                    <div id="historical-bar-chart-container">
                        <canvas id="historical-bar-chart"></canvas>
                    </div>
                    
                    <!-- Yield Table Container for Historical Data (initially hidden) -->
                    <div id="yield-table-container-his" style="display: none;">
                        <table id="data-table-his" class="styled-table data-table-his">
                            <thead>
                                <tr>
                                <th>Municipality</th>
                                <th>Year</th>
                                <th>Season</th>
                                <th>Yield (t/ha)</th>
                                </tr>
                            </thead>
                            <tbody id="historical-table-body-his">
                                {% for row in historical_yield_data %}
                                <tr>
                                    <td>{{ row.municipality }}</td>
                                    <td>{{ row.year }}</td>
                                    <td>{{ row.season }}</td>
                                    <td>{{ row.yield }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>  
                </div>
            </div>
        </div>
        
          <!-- Main Content Area -->
        <div id="content-container">
            <!-- Map Section --> 
            <div id="map-container">
                <iframe id="map-frame" src="{{ url_for('static', filename='map.html') }}" width="100%" height="600px" frameborder="0"></iframe> <!-- changes ni perl start -->
            </div>

            <!-- Bottom Container: Legend -->
            <div id="bottom-container">
                <div id="legend-container">
                    <div class="legend-item">
                        <span>Average Yield (tons/hectare):</span>
                    </div>
                </div>
            </div>
            </div>
        </div>   
    </div>

    <!-- Footer Section -->
    <footer>
        <div class="footer-section">
        <div class="footer-column">
            <h4>Connect with Us</h4>
            <p>
            <span>AgriKA</span><br>
            <i class="fas fa-phone"></i> +65 912 123 1234<br>
            <i class="fas fa-envelope"></i> agrika@gmail.com
            </p>
        </div>
        <div class="footer-column">
            <h4>Collaborators</h4>
            <div class="collaborator">
            <img src="{{ url_for('static', filename='images/Prism.png') }}" alt="PhilRice" class="small-logo">
            <span class="tooltip">PRiSM</span>
            </div>
        </div>
        </div>
        <hr>
        <p class="footer-copy">Copyright © 2025 All Rights Reserved by AgriKA</p>
    </footer>
  
</body>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const municipalitySearch = document.getElementById("municipality-search");
    const municipalityDropdown = document.getElementById("municipality-dropdown");
    const sortDropdown = document.getElementById("sort-dropdown");
    const graphToggleDropdown = document.getElementById("graph-toggle-dropdown");
    const barChartContainer = document.getElementById("bar-chart-container");
    const yieldTableContainer = document.getElementById("yield-table-container");
    const tableBody = document.getElementById("data-table").getElementsByTagName("tbody")[0];
    const municipalities = [
    "ALAMINOS", "BAY", "CABUYAO", "CALAUAN", "CAVINTI", "BINAN", "CALAMBA",
    "SANTA ROSA", "FAMY", "KALAYAAN", "LILIW", "LOS BANOS", "LUISIANA",
    "LUMBAN", "MABITAC", "MAGDALENA", "MAJAYJAY", "NAGCARLAN", "PAETE",
    "PAGSANJAN", "PAKIL", "PANGIL", "PILA", "RIZAL", "SAN PABLO", "SANTA CRUZ",
    "SANTA MARIA", "SINILOAN", "VICTORIA"
    ];

    let originalYieldData = []; 
    let currentChart = null;

    //  --- Toggle Real-Time / Historical Content --- //
    document.getElementById("realtime-btn").addEventListener("click", function () {
        document.getElementById("realtime-content").style.display = "block";
        document.getElementById("historical-content").style.display = "none";
        this.classList.add("active");
        document.getElementById("historical-btn").classList.remove("active");

        // Reset historical section when switching to real-time
        resetHistoricalSection();
        updateMap(); //changes ni perl
    });

    document.getElementById("historical-btn").addEventListener("click", function () {
        document.getElementById("realtime-content").style.display = "none";
        document.getElementById("historical-content").style.display = "block";
        this.classList.add("active");
        document.getElementById("realtime-btn").classList.remove("active");

        // Reset real-time section when switching to historical
        resetRealTimeSection();

        // Re-render chart after showing historical content
        setTimeout(function () {
            if (typeof myChart !== "undefined") {
                myChart.resize();
            }
        }, 100);

        updateMap(); //changes ni perl
    });

    //  --- Resets Real-Time / Historical Content --- //
    function resetRealTimeSection() {
        clearSearch();
    }

    function resetHistoricalSection() {
        clearHistoricalSearch();
    }

    // --- Search Bar for Real Time --- //
    document.getElementById("municipality-search").addEventListener("click", function() {
        showDropdown(); // Show all municipalities when clicked
    });

    document.getElementById("municipality-search").addEventListener("input", function() {
        let clearBtn = document.getElementById("clear-search");
        clearBtn.style.display = this.value.length > 0 ? "block" : "none";
        filterDropdown(); // ✅ Update dropdown while typing
    });


    function showDropdown() {
        let dropdown = document.getElementById("municipality-dropdown");
        dropdown.style.display = "block"; 
        populateDropdown(municipalities); // Show all municipalities
    }

    function filterDropdown() {
        let input = document.getElementById("municipality-search");
        let clearBtn = document.getElementById("clear-search");

        // Show x when input has text
        clearBtn.style.display = input.value.length > 0 ? "block" : "none";

        // Filter municipalities but DO NOT update chart/table here
        let filteredMunicipalities = municipalities.filter(m => 
            m.toUpperCase().includes(input.value.toUpperCase())
        );

        populateDropdown(filteredMunicipalities); 
    }


    function clearSearch() {
        let input = document.getElementById("municipality-search");
        let clearBtn = document.getElementById("clear-search");
        let sortDropdown = document.getElementById("sort-dropdown");

        // Clear input field
        input.value = "";
        // Hide x button
        clearBtn.style.display = "none";
        // Show sort dropdown again when clearing selection
        if (sortDropdown) {
            sortDropdown.style.display = "block";
        }
        // Hide dropdown
        document.getElementById("municipality-dropdown").style.display = "none";
        // Reset graph & table
        updateRealTimeGraph(
            originalYieldData.map(item => item.municipality),
            originalYieldData.map(item => item.yield)
        );
        updateRealTimeTable(originalYieldData);
    }


    document.getElementById("clear-search").addEventListener("click", clearSearch);

     // Function to hide dropdown
     function hiderealDropdown() {
        let dropdown = document.getElementById("municipality-dropdown");
        if (dropdown) {
            dropdown.style.display = "none"; 
    }
    }

    // Hide dropdown when scrolling anywhere on the page
    window.addEventListener("scroll", hiderealDropdown);

    // Hide dropdown when interacting with historical sections
    ["bar-chart-container", "yield-table-container"].forEach(id => {
        let element = document.getElementById(id);
        if (element) {
            element.addEventListener("wheel", hiderealDropdown); 
        }
    });

    // Track highlighted item
    let highlightedIndex = -1; 

    document.getElementById("municipality-search").addEventListener("keydown", function(event) {
        let items = document.querySelectorAll(".dropdown-item-real");
        let inputText = this.value.trim().toLowerCase();

        if (event.key === "Enter") {
            event.preventDefault();

            // If an item is highlighted, select it
            if (highlightedIndex >= 0) {
                selectOption(items[highlightedIndex].textContent);
                return;
            }

            // If no item is highlighted, check if input is an exact match
            let exactMatch = municipalities.find(m => m.toLowerCase() === inputText);
            if (exactMatch) {
                selectOption(exactMatch)
            }
        }

        if (event.key === "ArrowDown") {
            event.preventDefault();
            highlightedIndex = (highlightedIndex + 1) % items.length;
        } else if (event.key === "ArrowUp") {
            event.preventDefault();
            highlightedIndex = (highlightedIndex - 1 + items.length) % items.length;
        }

        // Remove previous highlights
        items.forEach(item => item.classList.remove("highlighted"));

        // Highlight the current selection
        if (highlightedIndex >= 0) {
            items[highlightedIndex].classList.add("highlighted");
            items[highlightedIndex].scrollIntoView({ block: "nearest", behavior: "smooth" });
        }
    });


    function populateDropdown(items) {
        let dropdown = document.getElementById("municipality-dropdown");
        dropdown.innerHTML = ""; 
        highlightedIndex = -1; 

        if (items.length === 0) {
            dropdown.innerHTML = `<div class="dropdown-item dropdown-no-results">No results found</div>`;
            return;
        }

        items.forEach((m, index) => {
            let option = document.createElement("div");
            option.className = "dropdown-item dropdown-item-real"; 
            option.textContent = m;
            option.dataset.index = index;

            option.onclick = function () {
                selectOption(m);
            };

            dropdown.appendChild(option);
        });
    }

    function selectOption(municipality) {
        let searchInput = document.getElementById("municipality-search");
        let dropdown = document.getElementById("municipality-dropdown");
        let clearBtn = document.getElementById("clear-search");
        let sortDropdown = document.getElementById("sort-dropdown");

        // Set input value to the selected municipality
        searchInput.value = municipality;

        // Show the x button
        clearBtn.style.display = "block";

        // Hide dropdown
        dropdown.style.display = "none";

        // Hide sort dropdown when a municipality is selected
        if (sortDropdown) {
            sortDropdown.style.display = "none";
        }

        // NOW we update the chart and table ONLY after selection
        let filteredData = originalYieldData.filter(item => item.municipality === municipality);
        updateRealTimeGraph(
            filteredData.map(item => item.municipality),
            filteredData.map(item => item.yield)
        );
        updateRealTimeTable(filteredData);
        
    }


    //  Close dropdown when clicking outside
    document.addEventListener("click", function(event) {
        let dropdown = document.getElementById("municipality-dropdown");
        let searchInput = document.getElementById("municipality-search");

        if (!searchInput.contains(event.target) && !dropdown.contains(event.target)) {
            dropdown.style.display = "none"; 
        }
    });

    // --- End Search Bar --- //


    function fetchRealTimeData() {
        fetch('/get_real_time_data')
            .then(response => response.json())
            .then(data => {
                if (!data.municipalities || !data.yields) {
                    console.error(" Error: Missing 'municipalities' or 'yields' in response", data);
                    return;
                }
                originalYieldData = data.municipalities.map((municipality, index) => ({
                    municipality: municipality,
                    yield: data.yields[index]
                }));
                updateRealTimeTable(originalYieldData);
                updateRealTimeGraph(data.municipalities, data.yields);
            })
            .catch(error => console.error(" Error fetching real-time data:", error));
    }

    function updateRealTimeTable(yieldData) {
        tableBody.innerHTML = "";
        yieldData.forEach(entry => {
            let row = `<tr>
                <td>${entry.municipality}</td>
                <td>${entry.yield}</td>
            </tr>`;
            tableBody.innerHTML += row;
        });
    }

    function updateRealTimeGraph(municipalities, yields) {
        let ctx = document.getElementById("bar-chart").getContext("2d");
        let container = document.getElementById("bar-chart-container");

        if (window.realTimeChart) {
            window.realTimeChart.destroy();
        }

        let isFiltered = municipalities.length < originalYieldData.length; 
        let chartTitle = "Real Time Yield Data";

        // If no selection is made, show all data
        //if (!isFiltered || municipalities.length === 0) {
        //    municipalities = originalYieldData.map(d => d.municipality);
        //    yields = originalYieldData.map(d => d.yield);
        //}

        
        let minHeight = 400; 
        let barHeight = 30; 
        let chartHeight = Math.max(minHeight, municipalities.length * barHeight);

        container.style.height = `${chartHeight}px`;

        window.realTimeChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: municipalities,
                datasets: [{
                    label: "Real-Time Yield (t/ha)",
                    data: yields,
                    backgroundColor: yields.map(y => {
                        let val = parseFloat(y);
                        return val < 0.75 ? "#d13237" : val < 1.5 ? "#ffc91f" : val < 2.25 ? "#69a436" : "#1b499f";
                    }),
                    borderRadius: 20,
                    borderWidth: 0,
                    barThickness: 15,  
                    categoryPercentage: 0.6,
                    barPercentage: 0.8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                scales: {
                    x: { 
                        beginAtZero: true,
                        grid: { color: "rgba(200, 200, 200, 0.2)", drawBorder: false },
                        ticks: { maxRotation: 0, autoSkip: true, font: { size: 12, weight: "bold" } }
                    },
                    y: { 
                        ticks: { autoSkip: false, font: { size: 14, weight: "bold" } }
                    }
                },
                plugins: {
                    legend: { display: false },
                    title: {
                    display: true,
                    text: chartTitle,
                    font: { size: 16, weight: "bold" }
                },
                    tooltip: {
                        backgroundColor: "#fff",
                        titleColor: "#000",
                        bodyColor: "#333",
                        borderColor: "#ddd",
                        borderWidth: 1,
                        cornerRadius: 8,
                        padding: 10
                    }
                },
                animation: {
                    duration: 1000,
                    easing: "easeInOutQuart"
                }
            }
        });

        console.log("New Chart Created!");

        // Auto-scroll to top when selection changes
        setTimeout(() => {
            container.scrollTop = 0;
        }, 300);
    }

    document.getElementById("municipality-search").addEventListener("input", function () {
        filterDropdown(); 

        if (this.value.trim() === "") {  
            clearSearch();
            showDropdown(); 
        }
    });



    sortDropdown?.addEventListener("change", function () {
        let sortedData = [...originalYieldData];
        if (this.value === "asc") {
            sortedData.sort((a, b) => parseFloat(a.yield) - parseFloat(b.yield));
        } else if (this.value === "desc") {
            sortedData.sort((a, b) => parseFloat(b.yield) - parseFloat(a.yield));
        }
        console.log("\n\n\n\nSorted Data:", sortedData);
        updateRealTimeTable(sortedData);
        updateRealTimeGraph(
            sortedData.map(item => item.municipality),
            sortedData.map(item => item.yield)
        );
    });

    graphToggleDropdown?.addEventListener("change", function () {
        barChartContainer.style.display = this.value === "bar" ? "block" : "none";
        yieldTableContainer.style.display = this.value === "table" ? "block" : "none";
    });

    //setInterval(fetchRealTimeData, 30000);
    fetchRealTimeData();

    // --- HISTORICAL CONTENTS --- //

    window.historicalDataGlobal = {{ historical_yield_data | tojson | safe }};
    console.log("Historical Data (global):", window.historicalDataGlobal);

    function clearHistoricalSearch() {
        let inputField = document.getElementById("municipality-search-his"); 
        let dropdownContainer = document.getElementById("municipality-dropdown-his");
        let clearButton = document.getElementById("clear-search-his"); 

        // Clear input field
        if (inputField) inputField.value = "";

        // Clear and hide the dropdown
        if (dropdownContainer) {
            dropdownContainer.innerHTML = "";
            dropdownContainer.style.display = "none";
        }

        // Hide the clear x button
        if (clearButton) clearButton.style.display = "none";

        // Reset historical view 
        updateHistoricalView();
        
    }

    // --- START OF SEARCH BAR HISTO --- //
    // Get elements
    const inputField = document.getElementById("municipality-search-his");
    const clearButton = document.getElementById("clear-search-his");
    // Create a fixed wrapper for the dropdown
    const dropdownWrapper = document.createElement("div");
    dropdownWrapper.classList.add("fixed-dropdown-wrapper");
    document.body.appendChild(dropdownWrapper);
    // Create dropdown container
    const dropdownContainer = document.createElement("div");
    dropdownContainer.id = "municipality-dropdown-his";
    dropdownContainer.classList.add("dropdown-list");
    dropdownWrapper.appendChild(dropdownContainer);

    let selectedIndex = -1;
    let filteredMunicipalities = [];

    // Position dropdown below the search bar
    function positionDropdown() {
        let rect = inputField.getBoundingClientRect();
        dropdownContainer.style.top = `${rect.bottom}px`;
        dropdownContainer.style.left = `${rect.left}px`;
        dropdownContainer.style.width = `${rect.width}px`;
        dropdownContainer.style.display = "block";
    }

    // Show dropdown on focus or click
    inputField?.addEventListener("focus", () => {
        showMunicipalityDropdown(inputField.value.trim());
        clearButton.style.display = inputField.value.trim() ? "block" : "none";
        positionDropdown();
    });

    inputField.addEventListener("click", function () {
        showMunicipalityDropdown("");
        positionDropdown();
    });

    // Handle input changes
    inputField.addEventListener("input", function () {
        let trimmedValue = inputField.value.trim();
        showMunicipalityDropdown(trimmedValue);

        if (trimmedValue) {
            clearButton.style.display = "block";
        } else {
            clearButton.style.display = "none";
            dropdownContainer.style.display = "none";
            updateHistoricalView(); 
            showMunicipalityDropdown();
        }
    });


    // Adjust dropdown position on window resize
    window.addEventListener("resize", () => {
        if (dropdownContainer.style.display === "block") positionDropdown();
    });

    // Show matching municipalities in dropdown
    function showMunicipalityDropdown(inputText = "") {
        dropdownContainer.innerHTML = "";
        selectedIndex = -1;
        let trimmedText = inputText.trim().toLowerCase();

        filteredMunicipalities = trimmedText
            ? municipalities.filter(m => m.toLowerCase().startsWith(trimmedText))
            : [...municipalities];

        // 
        if (filteredMunicipalities.length === 0) {
            dropdownContainer.innerHTML = `<div class="dropdown-item-his dropdown-no-results">No results found</div>`;
            dropdownContainer.style.display = "block"; 
            return;
        }

        positionDropdown();
        dropdownContainer.style.maxHeight = "200px";
        dropdownContainer.style.overflowY = "auto";

        filteredMunicipalities.forEach((municipality, index) => {
            let option = document.createElement("div");
            option.classList.add("dropdown-item-his");
            option.textContent = municipality;
            option.dataset.index = index;
            option.addEventListener("click", () => selectMunicipality(index));
            dropdownContainer.appendChild(option);
        });
    }


    // Select municipality from dropdown
    function selectMunicipality(index) {
        if (index >= 0 && index < filteredMunicipalities.length) {
            inputField.value = filteredMunicipalities[index];
            dropdownContainer.style.display = "none";
            clearButton.style.display = "block";
            updateHistoricalView();
        }
    }

    // Handle keyboard navigation
    inputField.addEventListener("keydown", function (event) {
        let items = document.querySelectorAll(".dropdown-item-his");
        if (items.length === 0) return;

        if (event.key === "ArrowDown") {
            event.preventDefault();
            selectedIndex = (selectedIndex + 1) % items.length;
        } else if (event.key === "ArrowUp") {
            event.preventDefault();
            selectedIndex = (selectedIndex - 1 + items.length) % items.length;
        } else if (event.key === "Enter") {
            event.preventDefault();
            if (selectedIndex >= 0) {
                selectMunicipality(selectedIndex);
            } else {
                let typedMunicipality = inputField.value.trim();
                let matchedIndex = filteredMunicipalities.findIndex(m => m.toLowerCase() === typedMunicipality.toLowerCase());
                if (matchedIndex !== -1) selectMunicipality(matchedIndex);
            }
            return;
        }

        items.forEach(item => item.classList.remove("highlighted"));
        if (selectedIndex >= 0) {
            items[selectedIndex].classList.add("highlighted");
            items[selectedIndex].scrollIntoView({ block: "nearest", behavior: "smooth" });
        }
    });

    // Show clear button when selecting a municipality from dropdown
    document.addEventListener("click", (event) => {
        if (event.target.classList.contains("dropdown-item-his")) {
            clearButton.style.display = "block";
        }
    });

    // Clear search field and reset view
    clearButton.addEventListener("click", function () {
        inputField.value = "";
        clearButton.style.display = "none";
        dropdownContainer.style.display = "none";
        updateHistoricalView();
    });

    // Hide dropdown when clicking outside
    document.addEventListener("click", event => {
        if (!inputField.contains(event.target) && !dropdownContainer.contains(event.target)) {
            dropdownContainer.style.display = "none";
        }
    });

    // Hide dropdown on scroll
    window.addEventListener("scroll", () => dropdownContainer.style.display = "none");

    // Hide dropdown when interacting with specific sections
    ["historical-bar-chart-container", "yield-table-container-his"].forEach(id => {
        let element = document.getElementById(id);
        if (element) {
            element.addEventListener("wheel", () => dropdownContainer.style.display = "none");
        }
    });

    // --- END OF SEARCH BAR HISTO --- //


    // --- CHART AND TABLE --- //
    // Function to update historical chart
    function updateHistoricalChart(data) {
    let canvas = document.getElementById("historical-bar-chart");
    if (!canvas) return;
    let ctx = canvas.getContext("2d");

    if (window.historicalChartInstance) {
        window.historicalChartInstance.destroy();
    }

    let chartTitleHis = "Historical Yield Data";

    window.historicalChartInstance = new Chart(ctx, {
        type: "bar",
        data: {
            labels: data.map(item => `${item.municipality} (${item.year}, Season ${item.season})`), 
            datasets: [{
                label: "Historical Yield (t/ha)",
                data: data.map(item => item.yield),
                backgroundColor: data.map(item => {
                    let y = parseFloat(item.yield);
                    return y < 3 ? "#d13237" : y < 4 ? "#ffc91f" : y < 5 ? "#69a436" : "#1b499f";
                }),
                borderWidth: 0,
                borderRadius: 20,
                barThickness: 15,
                categoryPercentage: 0.6,
                barPercentage: 0.7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: { beginAtZero: true, grid: { color: "rgba(200, 200, 200, 0.2)", drawBorder: false } },
                y: { ticks: { autoSkip: false, font: { size: 14, weight: "bold" } } }
            },
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: chartTitleHis,
                    font: { size: 16, weight: "bold" }
                },
                tooltip: {
                    callbacks: {
                        title: (tooltipItems) => tooltipItems[0].label, 
                        label: (tooltipItem) => `Yield: ${tooltipItem.raw} t/ha`
                    },
                    backgroundColor: "#fff",
                    titleColor: "#000",
                    bodyColor: "#333",
                    borderColor: "#ddd",
                    borderWidth: 1,
                    cornerRadius: 8,
                    padding: 10
                }
            },
            animation: { duration: 1000, easing: "easeInOutQuart" }
        }
    });
}

    // Function to update historical table
    function updateHistoricalTable(data) {
        let tbody = document.getElementById("historical-table-body-his");
        if (!tbody) return;

        tbody.innerHTML = data.length === 0 
            ? "<tr><td colspan='3'>No Data</td></tr>" 
            : data.map(item => 
                `<tr>
                    <td>${item.municipality}</td>  
                    <td>${item.year}</td>
                    <td>${item.season}</td>
                    <td>${item.yield === 0 ? "No Data" : item.yield}</td>
                </tr>`
            ).join('');
    }


    // Function to update view
    function updateHistoricalView() {
        let selectedMunicipality = inputField?.value.trim().toUpperCase() || "";
        let selectedYear = document.getElementById("year-dropdown-his")?.value || "";
        let selectedSeason = document.getElementById("season-dropdown-his")?.value || "";
        let data = window.historicalDataGlobal;

        selectedSeason = selectedSeason.toLowerCase() === "season1" ? "1" : 
                        selectedSeason.toLowerCase() === "season2" ? "2" : selectedSeason;

        if (selectedMunicipality && municipalities.includes(selectedMunicipality)) {
            data = data.filter(item => item.municipality.toUpperCase() === selectedMunicipality);

            document.getElementById("year-dropdown-his").style.display = "none";
            document.getElementById("season-dropdown-his").style.display = "none";
        } else {
            document.getElementById("year-dropdown-his").style.display = "block";
            document.getElementById("season-dropdown-his").style.display = "block";

            data = window.historicalDataGlobal.filter(item => 
                (!selectedYear || item.year == selectedYear) && 
                (!selectedSeason || item.season == selectedSeason)
            );
        }

        document.getElementById("graph-toggle-dropdown-his").style.display = "block";
        document.getElementById("sort-dropdown-his").style.display = "block";

        // If no data exists, show "No Data Available" and stop execution
        if (data.length === 0) {
            document.getElementById("historical-table-body-his").innerHTML =
                "<tr><td colspan='3'>No Data Available</td></tr>";

            document.getElementById("historical-bar-chart-container").style.display = "none";
            document.getElementById("yield-table-container-his").style.display = "block";

            return; 
        }

        let sortOrder = document.getElementById("sort-dropdown-his")?.value;
        if (sortOrder === "asc") {
            data.sort((a, b) => parseFloat(a.yield) - parseFloat(b.yield));
        } else if (sortOrder === "desc") {
            data.sort((a, b) => parseFloat(b.yield) - parseFloat(a.yield));
        }

        let toggleValue = document.getElementById("graph-toggle-dropdown-his")?.value;
        if (toggleValue === "bar") {
            document.getElementById("historical-bar-chart-container").style.display = "block";
            document.getElementById("yield-table-container-his").style.display = "none";
            updateHistoricalChart(data);
        } else {
            document.getElementById("historical-bar-chart-container").style.display = "none";
            document.getElementById("yield-table-container-his").style.display = "block";
            updateHistoricalTable(data);
        }
        updateMap();
    }


    document.getElementById("year-dropdown-his")?.addEventListener("change", updateHistoricalView);
    document.getElementById("season-dropdown-his")?.addEventListener("change", updateHistoricalView);
    document.getElementById("graph-toggle-dropdown-his")?.addEventListener("change", updateHistoricalView);
    document.getElementById("sort-dropdown-his")?.addEventListener("change", updateHistoricalView);


    // Initialize view on load
    updateHistoricalView();

    // --- LEGEND ITEMS --- //
    const legendContainer = document.getElementById("legend-container");
    const realtimeBtn = document.getElementById("realtime-btn");
    const historicalBtn = document.getElementById("historical-btn");

    const historicalLegend = [
        { color: "#d13237", label: "< 3" },
        { color: "#ffc91f", label: "3 - 4" },
        { color: "#69a436", label: "4 - 5" },
        { color: "#1b499f", label: "> 5" }
    ];

    const realtimeLegend = [
        { color: "#d13237", label: "< 0.75" },
        { color: "#ffc91f", label: "0.75 - 1.5" },
        { color: "#69a436", label: "1.5 - 2.25" },
        { color: "#1b499f", label: "> 2.25" }
    ];

    function updateLegend(legendData) {
        legendContainer.innerHTML = ""; // Clear existing legend

        const legendTitle = document.createElement("div");
        legendTitle.classList.add("legend-item");
        legendTitle.textContent = "Avg. Yield (t/ha):";
        legendContainer.appendChild(legendTitle);

        legendData.forEach(item => {
            const legendItem = document.createElement("div");
            legendItem.classList.add("legend-item");

            const legendBox = document.createElement("div");
            legendBox.classList.add("legend-box");
            legendBox.style.backgroundColor = item.color;

            const legendLabel = document.createElement("span");
            legendLabel.textContent = item.label;

            legendItem.appendChild(legendBox);
            legendItem.appendChild(legendLabel);
            legendContainer.appendChild(legendItem);
        });
    }

    // Default to Real-Time legend
    updateLegend(realtimeLegend);

    realtimeBtn.addEventListener("click", function () {
        updateLegend(realtimeLegend);
        realtimeBtn.classList.add("active");
        historicalBtn.classList.remove("active");
    });

    historicalBtn.addEventListener("click", function () {
        updateLegend(historicalLegend);
        historicalBtn.classList.add("active");
        realtimeBtn.classList.remove("active");
    });

    //changes ni perl start
    const mapFrame = document.getElementById("map-frame");
    const yearDropdown = document.getElementById("year-dropdown-his");
    const seasonDropdown = document.getElementById("season-dropdown-his");


    function updateMap() {
        let mapFrame = document.getElementById("map-frame");
        if (!mapFrame) {
            console.error("map-frame not found!");
            return;
        }
        
        let activeTab = document.querySelector(".hist-toggle-btn.active")?.id; // Ensure it exists
        let municipalityInput = document.getElementById("municipality-search-his").value.trim()

        console.log("Active tab:", activeTab); // Debugging
        console.log("Municipality search:", municipalityInput); // Debugging

        // 📌 1️⃣ Prioritize Municipality Search First
        if (municipalityInput) {
            let formattedMunicipality = municipalityInput.replace(/\s+/g, "_").toLowerCase();
            mapFrame.src = `/static/map_${formattedMunicipality}.html`;
            console.log("Updated map src:", mapFrame.src); // Debugging
            return; // Stop function here if municipality is selected
        }

        // 📌 2️⃣ Handle Realtime & Historical Toggle Logic
        if (activeTab === "realtime-btn") {
            mapFrame.src = "{{ url_for('static', filename='map.html') }}";
        } else if (activeTab === "historical-btn") {
            let yearDropdown = document.getElementById("year-dropdown-his");
            let seasonDropdown = document.getElementById("season-dropdown-his");

            if (!yearDropdown || !seasonDropdown) {
                console.warn("Year or season dropdowns not found.");
                return;
            }

            let year = yearDropdown.value;
            let season = seasonDropdown.value;

            if (season.toLowerCase() === "season1") season = "1";
            if (season.toLowerCase() === "season2") season = "2";

            console.log("Selected Year:", year); // Debugging
            console.log("Selected Season:", season); // Debugging

            if (year && season) {
                mapFrame.src = `/static/historical_map_${year}_${season}.html`;
                console.log("Updated map src:", mapFrame.src); // Debugging
            } else {
                console.warn("Year or season not selected.");
            }
        }
    }

    if (yearDropdown) yearDropdown.addEventListener("change", updateMap);
    if (seasonDropdown) seasonDropdown.addEventListener("change", updateMap);
    //changes ni perl end

    //changes ni perl start
    let municipalityInput = document.getElementById("municipality-search-his");
    let municipalityDropdownHis = document.getElementById("municipality-dropdown-his");
    municipalityInput.addEventListener("input", updateMap);

    municipalityInputHis.addEventListener("click", updateMap);

    if (municipalityDropdownHis) {
        // Use event delegation to handle dynamically added items
        municipalityDropdown.addEventListener("click", function (event) {
            //let selectedOption = event.target; // Get clicked item
            let selectedOption = document.getElementById("municipality-search");
            console.log(selectOption);
            print(selectOption);

            if (selectedOption.classList.contains("dropdown-item")) { // Ensure it's a valid option
                let selectedText = selectedOption.textContent.trim();
                console.log("Dropdown selected:", selectedText);

                // Update input field
                municipalityInput.value = selectedText;

                // Call updateMap() after selection
                updateMap(); 
            }
        });
    } else {
        console.error("municipality-dropdown-his not found!");
    }//changes ni perl end

});

</script>
</html>


