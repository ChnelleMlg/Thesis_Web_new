<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Josefin Sans'>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href='https://fonts.googleapis.com/css?family=Source Sans Pro' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css" />
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" />
    <!-- Font Awesome or other libraries -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" />
    <!-- Custom Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <!-- jQuery(-->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <!-- Chart JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>

</head>
<body>
    <!-- Main Container -->
    <main class="container">
        <!-- Navigation Bar -->
        <nav>
            <div class="nav-container">
              <!-- Logo Section -->
              <div class="nav-logo">
                <a href="{{ url_for('home') }}">
                  <img src="{{ url_for('static', filename='images/AgriKA.png') }}" alt="Logo">
                </a>
              </div>
              <!-- Navigation Links -->
              <ul class="nav-links">
                <li>
                  <a href="{{ url_for('home') }}">
                    <img src="{{ url_for('static', filename='images/Home.png') }}" alt="Home">
                    <span class="tooltip">Home</span>
                  </a>
                </li>
                <li>
                  <a href="{{ url_for('view') }}">
                    <img src="{{ url_for('static', filename='images/Yield.png') }}" alt="Yield">
                    <span class="tooltip">Map</span>
                  </a>
                </li>
                <li>
                    <a href="{{ url_for('dashboard') }}">
                        <span class="tooltip">Analytics</span>
                    </a>
                </li>
              </ul>
            </div>
        </nav>
        
        <div id="title-filter-container" class="row my-4">
            <div class="col-md-12">
                <h1 class="my-4">Laguna Rice Yield</h1>
            </div>
            <hr class="my-1" />
        </div>

        <div class="row my-4">
            <div id="filters-container" class="card col-md-2">
                <div class="row my-4">
                    <div class="col-12">
                        <p>FILTERS</p>
                    </div>
                    <div class="row">
                        <!-- Municipality Search for Historical -->
                        <div class="dropdown-container-his my-2">
                            <input type="text" id="municipality-search-his" placeholder="Select municipality" autocomplete="off">
                            <span id="clear-search-his">❌</span>
                            <div class="dropdown-wrapper">
                                <div id="municipality-dropdown-his" class="dropdown-list"></div>
                            </div>
                        </div>
                        <div id="time-switch-radio-button-container">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exampleRadios" id="real-time-radio-btn" value="option1" checked>
                                <label class="form-check-label" for="exampleRadios1">
                                    Real-Time View
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="exampleRadios" id="historical-radio-btn" value="option2">
                                <label class="form-check-label" for="exampleRadios2">
                                    Historical View
                                </label>
                            </div>
                        </div>
                        
                        <div id="year-filter-container">
                            <!-- Year Selection Dropdown -->
                            <p>Year:
                                <select id="year-dropdown-his">
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                    <option value="2022">2022</option>
                                    <option value="2021">2021</option>
                                    <option value="2020">2020</option>
                                    <option value="2019">2019</option>
                                    <option value="2018">2018</option>
                                </select>
                            </p>
                        </div>

                        <div id="season-filter-container">
                            <div class="col-md-3">
                                <!-- Season Selection Dropdown -->
                                <p>Season:
                                    <select id="season-dropdown-his">
                                        <option value="season1">Wet</option> <!-- Updated season names here -Zoe -->
                                        <option value="season2">Dry</option>
                                    </select>
                                </p>
                            </div>
                        </div>

                        </div>
                    </div>
            </div>

            <div id="kpi-map-charts-container" class="col-md-10">
                <!-- KPIs -->
                <div id="kpi-container" class="row my-4">
                    <div class="col-md-3">
                        <div class="card kpi-card text-center shadow-sm">
                            <div class="card-body">
                                <h5 id="kpi-label-1">Laguna Avg. Yield</h5>
                                <p class="h3 text-success">
                                    <!--{{ yearly_trends.averages | sum / yearly_trends.averages|length | round(2) }} t/ha-->
                                </p>
                                <p id="kpi-value-1">—</p>

                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center shadow-sm">
                            <div class="card-body">
                                <h5 id="kpi-label-2">Top Municipality</h5>
                                <p id="kpi-value-2">—</p>
                                <p class="h3 text-success">
                                    <!--<strong id="top-muni-display">—</strong>-->
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="card text-center shadow-sm">
                            <div class="card-body">
                                <h5 id="kpi-label-3">Lowest Municipality</h5>
                                <p id="kpi-value-3">—</p>
                                <p class="h3 text-success">
                                    <!--<strong id="lowest-muni-display">—</strong>-->
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center shadow-sm">
                            <div class="card-body">
                                <h5>NDVI Alert Municipalities</h5>
                                <p class="h3 text-success">
                                    insert ndvi stats here
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MAP 
                <div id="analytics-map" class="card row mx-1 my-4">
                    <p> MAP </p>
                </div>-->

                <!-- CHARTS -->
                <div id="chart-container" class="row mx-1 my-4">
                    <div id="yield-distribution-chart" class="card col-md-4">
                        <p>CHART HERE</p>
                    </div>

                    <div id="yield-line-chart-wrapper" class="col-md-4" style="height:300px;">
                        <!-- Laguna-wide Trend Chart (shown by default) -->
                        <div id="laguna-line-chart-container" class="card  mb-4 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Yearly Average Yield</h5>
                                <canvas id="yearlyTrendChart" style="max-height: 225px; width: 100%;"></canvas>
                            </div>
                        </div>

                        <!-- Municipality-specific chart (initially hidden) -->
                        <div id="municipality-line-chart-container" class="card mb-4 shadow-sm" style="display: none;">
                            <div class="card-body">
                                <h5 class="card-title" id="muni-line-title">Municipality Yearly Yield</h5>
                                <canvas id="municipality-line-chart" style="max-height: 225px; width: 100%;"></canvas>
                            </div>
                        </div>
                    </div>  
                
                    

                    <div id="yield-distribution-chart" class="card col-md-4">
                        <p>CHART HERE</p>
                    </div>
                </div>
            </div>
            <!--<div id="kpi-map-container" class="card col-md-2">
                <p>OTHER CHUCHU</p>
            </div>-->
        </div>

        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Yearly Yield Trend</h5>
                <canvas id="municipality-line-chart"></canvas>
            </div>
        </div>

        <div class="card mb-4 shadow-sm" style="height: 400px;">
            <div class="card-body" style="height: 100%;">
                <h5 class="card-title">Seasonal Yield Over Time</h5>
                <canvas id="seasonal-yield-muni-chart" style="height: 100%; width: 100%;"></canvas>
            </div>
        </div>

        <div id="filter-container" class="row my-4">
            <div class="col-md-6">
                <div id="toggle-container-his">
                    <!-- Municipality Search for Historical -->
                    <div class="dropdown-container-his">
                        <input type="text" id="municipality-search-his" placeholder="Select municipality" autocomplete="off">
                        <span id="clear-search-his">❌</span>
                        <div class="dropdown-wrapper">
                            <div id="municipality-dropdown-his" class="dropdown-list"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <!-- Year Selection Dropdown -->
                <p>Year:
                <select id="year-dropdown-his">
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                    <option value="2021">2021</option>
                    <option value="2020">2020</option>
                    <option value="2019">2019</option>
                    <option value="2018">2018</option>
                </select> </p>
            </div>
        </div>

        
        
            <hr class="my-1" />

        <!-- Dashboard -->

        <div class="container">
            <!-- KPIs -->
            <div id="kpi-container" class="row my-4">
                <div class="col-md-3">
                    <div class="card kpi-card text-center shadow-sm">
                        <div class="card-body">
                            <h5 id="avg-yield-kpi-label">Avg Yield</h5>
                            <p class="h3 text-success">
                                {{ yearly_trends.averages | sum / yearly_trends.averages|length | round(2) }} t/ha
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <h5>Laguna Yield Rank</h5>
                            <p class="h3">
                                <strong id="kpi-rank">—</strong>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <h5>Yield % Above Laguna Avg.</h5>
                            <p class="h3">
                                <strong id="kpi-vs-laguna">—</strong>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center shadow-sm">
                        <div class="card-body">
                            <h5>Yield Growth Rate</h5>
                            <p class="h3 text-success">
                                {{ yearly_trends.averages | sum / yearly_trends.averages|length | round(2) }} t/ha
                            </p>
                        </div>
                    </div>
                </div>
            </div>


            <div id="yoy-change-container">
                <h5>Year-over-Year Yield Change</h5>
                <table id="yoy-change-table" class="styled-table">
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>% Change</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        
            <!-- Municipality Yield Chart -->
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Average Yield by Municipality</h5>
                    <canvas id="municipalityChart"></canvas>
                </div>
            </div>
        
            <!-- Seasonal Yield -->
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Seasonal Yield Over Time</h5>
                    <canvas id="seasonalChart"></canvas>
                </div>
            </div>
        </div>
        
    </main>

    <!-- Footer Section -->
    <footer>
        <div class="footer-section">
        <div class="footer-column">
            <h4>Connect with Us</h4>
            <p>
            <span>AgriKA</span><br>
            <i class="fas fa-phone"></i> +65 912 123 1234<br>
            <i class="fas fa-envelope"></i> agrika@gmail.com
            </p>
        </div>
        <div class="footer-column">
            <h4>Collaborators</h4>
            <div class="collaborator">
            <img src="{{ url_for('static', filename='images/Prism.png') }}" alt="PhilRice" class="small-logo">
            <span class="tooltip">PRiSM</span>
            </div>
        </div>
        </div>
        <hr>
        <p class="footer-copy">Copyright © 2025 All Rights Reserved by AgriKA</p>
    </footer>
  
</body>

<script>
    const yearlyCtx = document.getElementById('yearlyTrendChart').getContext('2d');
    new Chart(yearlyCtx, {
        type: 'line',
        data: {
            labels: {{ yearly_trends.years | tojson }},
        datasets: [{
            label: 'Average Yield (t/ha)',
            data: {{ yearly_trends.averages | tojson }},
        fill: true,
        borderColor: 'green',
        backgroundColor: 'rgba(0,128,0,0.2)',
        tension: 0.4
            }]
        },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: "top"
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: "Yield (t/ha)"
                }
            },
            x: {
                title: {
                    display: true,
                    text: "Year"
                    }
                }
            }
        }
        
    });

    const muniCtx = document.getElementById('municipalityChart').getContext('2d');
    new Chart(muniCtx, {
        type: 'bar',
        data: {
            labels: {{ municipality_averages.municipalities | tojson }},
        datasets: [{
            label: 'Yield (t/ha)',
            data: {{ municipality_averages.averages | tojson }},
        backgroundColor: 'rgba(0,123,255,0.6)'
            }]
        }
    });

    const seasonalCtx = document.getElementById('seasonalChart').getContext('2d');
    const seasonalData = {{ seasonal_data.data | tojson }};
    const seasons = {{ seasonal_data.seasons | tojson }};
    const years = {{ yearly_trends.years | tojson }};

    new Chart(seasonalCtx, {
        type: 'bar',
        data: {
            labels: years,
            datasets: seasons.map((season, i) => ({
                label: season,
                data: years.map(year => seasonalData[season][year] || 0),
                backgroundColor: `rgba(${100 + i * 50}, 100, 200, 0.5)`
            }))
        }
    });
</script>
    
<script>
document.addEventListener("DOMContentLoaded", function () {
    const municipalities = [
    "ALAMINOS", "BAY", "CABUYAO", "CALAUAN", "CAVINTI", "BIÑAN", "CALAMBA",
    "SANTA ROSA", "FAMY", "KALAYAAN", "LILIW", "LOS BAÑOS", "LUISIANA",
    "LUMBAN", "MABITAC", "MAGDALENA", "MAJAYJAY", "NAGCARLAN", "PAETE",
    "PAGSANJAN", "PAKIL", "PANGIL", "PILA", "RIZAL", "SAN PABLO", "SANTA CRUZ",
    "SANTA MARIA", "SINILOAN", "VICTORIA"
    ];
    window.historicalDataGlobal = {{ historical_yield_data | tojson | safe }};
    const year = parseInt(document.getElementById("year-dropdown-his").value);
    showLagunaKPIs(window.historicalDataGlobal, year);

    // ZOE CHANGES START HERE

    const searchInput = document.getElementById("municipality-search-his");
    const dropdown = document.getElementById("municipality-dropdown-his");
    const clearBtn = document.getElementById("clear-search-his");

    function populateDropdown(items) {
            const dropdown = document.getElementById("municipality-dropdown-his");
            dropdown.innerHTML = "";

            if (items.length === 0) {
                dropdown.innerHTML = "<div class='dropdown-item'>No results found</div>";
                return;
            }

            items.forEach(muni => {
                const div = document.createElement("div");
                div.className = "dropdown-item";
                div.textContent = muni;
                div.onclick = () => {
                    console.log("✅ Municipality selected:", muni);  // Debug log

                    document.getElementById("municipality-search-his").value = muni;
                    dropdown.style.display = "none";
                    document.getElementById("clear-search-his").style.display = "inline";

                    const selectedYear = parseInt(document.getElementById("year-dropdown-his").value);
                    console.log("📅 Selected Year:", selectedYear);  // Another debug log
                    
                    // Update KPIs
                    updateMunicipalityKPIs(muni, selectedYear);

                    // 🎯 Create seasonal yield chart
                    createSeasonalYieldChartForMunicipality(window.historicalDataGlobal, muni);

                    // Line chart for municipality yieds
                    createLineChartForMunicipality(window.historicalDataGlobal, muni);

                    // 🔁 Switch chart views
                    document.getElementById("laguna-line-chart-container").style.display = "none";
                    document.getElementById("municipality-line-chart-container").style.display = "block";
                    document.getElementById("muni-line-title").textContent = `${muni} Yearly Yield`;

                };
                dropdown.appendChild(div);
            });
        }

    // Event listeners
    searchInput.addEventListener("input", () => {
        const input = searchInput.value.toUpperCase();
        const filtered = municipalities.filter(m => m.includes(input));
        populateDropdown(filtered);
        dropdown.style.display = "block";
        clearBtn.style.display = input.length ? "inline" : "none";
    });

    searchInput.addEventListener("focus", () => {
        populateDropdown(municipalities);
        dropdown.style.display = "block";
    });

    clearBtn.addEventListener("click", () => {
        searchInput.value = "";
        dropdown.style.display = "none";
        clearBtn.style.display = "none";
    });

    document.addEventListener("click", function (e) {
        if (!e.target.closest(".dropdown-container-his")) {
            dropdown.style.display = "none";
        }
    });

    // TOP MUNICIPALITY KPI LOGIC
    function getTopMunicipalityByYear(data, year) {
            const yieldsByMuni = {};

            data.forEach(entry => {
                if (entry.year == year) {
                    if (!yieldsByMuni[entry.municipality]) {
                        yieldsByMuni[entry.municipality] = [];
                    }
                    yieldsByMuni[entry.municipality].push(parseFloat(entry.yield));
                }
            });

            let topMuni = null;
            let topAvg = -Infinity;

            for (let muni in yieldsByMuni) {
                const avg = yieldsByMuni[muni].reduce((a, b) => a + b, 0) / yieldsByMuni[muni].length;
                if (avg > topAvg) {
                    topAvg = avg;
                    topMuni = muni;
                }
            }

            if (!topMuni) return null;

            return {
                municipality: topMuni,
                average_yield: Math.round(topAvg * 100) / 100
            };
        }

        document.getElementById("year-dropdown-his").addEventListener("change", function () {
                const selectedYear = parseInt(this.value);

                const topResult = getTopMunicipalityByYear(window.historicalDataGlobal, selectedYear);
                const bottomResult = getLowestMunicipalityByYear(window.historicalDataGlobal, selectedYear);

                if (topResult) {
                    document.getElementById("top-muni-display").textContent =
                        `${topResult.municipality} (${topResult.average_yield} t/ha)`;
                } else {
                    document.getElementById("top-muni-display").textContent = "No data";
                }

                if (bottomResult) {
                    document.getElementById("lowest-muni-display").textContent =
                        `${bottomResult.municipality} (${bottomResult.average_yield} t/ha)`;
                } else {
                    document.getElementById("lowest-muni-display").textContent = "No data";
                }
            });

        window.addEventListener("DOMContentLoaded", function () {
                const initialYear = parseInt(document.getElementById("year-dropdown-his").value);

                const topResult = getTopMunicipalityByYear(window.historicalDataGlobal, initialYear);
                const bottomResult = getLowestMunicipalityByYear(window.historicalDataGlobal, initialYear);

                if (topResult) {
                    document.getElementById("top-muni-display").textContent =
                        `${topResult.municipality} (${topResult.average_yield} t/ha)`;
                }

                if (bottomResult) {
                    document.getElementById("lowest-muni-display").textContent =
                        `${bottomResult.municipality} (${bottomResult.average_yield} t/ha)`;
                }
            });

    function getLowestMunicipalityByYear(data, year) {
            const yieldsByMuni = {};

            // Group yields by municipality
            data.forEach(entry => {
                if (entry.year == year) {
                    if (!yieldsByMuni[entry.municipality]) {
                        yieldsByMuni[entry.municipality] = [];
                    }
                    yieldsByMuni[entry.municipality].push(parseFloat(entry.yield));
                }
            });

            // Build an array of {municipality, avgYield}
            const muniAverages = Object.entries(yieldsByMuni).map(([muni, yields]) => ({
                municipality: muni,
                average_yield: yields.reduce((a, b) => a + b, 0) / yields.length
            }));

            if (muniAverages.length === 0) return null;

            // Sort ascending by yield
            muniAverages.sort((a, b) => a.average_yield - b.average_yield);

            // If SAN PEDRO is the lowest, return the second lowest
            if (muniAverages[0].municipality === "SAN PEDRO") {
                return muniAverages[1]
                    ? {
                        municipality: muniAverages[1].municipality,
                        average_yield: Math.round(muniAverages[1].average_yield * 100) / 100
                    }
                    : null; // No second option
            }

            // Otherwise, return the actual lowest
            return {
                municipality: muniAverages[0].municipality,
                average_yield: Math.round(muniAverages[0].average_yield * 100) / 100
            };
        }

    function getYearOverYearYieldChange(data) {
            const yieldsByYear = {};

            // Group all yields by year
            data.forEach(entry => {
                const year = parseInt(entry.year);
                const yieldValue = parseFloat(entry.yield);
                if (!yieldsByYear[year]) {
                    yieldsByYear[year] = [];
                }
                yieldsByYear[year].push(yieldValue);
            });

            // Sort the years chronologically
            const sortedYears = Object.keys(yieldsByYear).map(Number).sort((a, b) => a - b);

            const yearChanges = [];

            for (let i = 1; i < sortedYears.length; i++) {
                const prevYear = sortedYears[i - 1];
                const currYear = sortedYears[i];

                const prevAvg = yieldsByYear[prevYear].reduce((a, b) => a + b, 0) / yieldsByYear[prevYear].length;
                const currAvg = yieldsByYear[currYear].reduce((a, b) => a + b, 0) / yieldsByYear[currYear].length;

                const change = ((currAvg - prevAvg) / prevAvg) * 100;

                yearChanges.push({
                    year: currYear,
                    change: Math.round(change * 100) / 100  // Round to 2 decimal places
                });
            }

            return yearChanges;
        }

    function displayYearOverYearChanges(data) {
            const changes = getYearOverYearYieldChange(data);
            const tableBody = document.querySelector("#yoy-change-table tbody");
            tableBody.innerHTML = ""; // Clear previous rows

            if (changes.length === 0) {
                tableBody.innerHTML = "<tr><td colspan='2'>No data available</td></tr>";
                return;
            }

            changes.forEach(change => {
                const row = document.createElement("tr");

                const yearCell = document.createElement("td");
                yearCell.textContent = change.year;

                const changeCell = document.createElement("td");
                changeCell.textContent = `${change.change > 0 ? "+" : ""}${change.change}%`;
                changeCell.style.color = change.change >= 0 ? "green" : "red";

                row.appendChild(yearCell);
                row.appendChild(changeCell);
                tableBody.appendChild(row);
            });
        }

    window.addEventListener("DOMContentLoaded", function () {
                displayYearOverYearChanges(window.historicalDataGlobal);
            });

    function getMunicipalityLagunaRank(data, targetMunicipality, targetYear) {
            const yieldsByMuni = {};

            // Filter by year and group yields by municipality
            data.forEach(entry => {
                if (entry.year == targetYear) {
                    if (!yieldsByMuni[entry.municipality]) {
                        yieldsByMuni[entry.municipality] = [];
                    }
                    yieldsByMuni[entry.municipality].push(parseFloat(entry.yield));
                }
            });

            // Compute average yield per municipality
            const muniAverages = Object.entries(yieldsByMuni).map(([municipality, yields]) => ({
                municipality,
                avgYield: yields.reduce((a, b) => a + b, 0) / yields.length
            }));

            // Sort in descending order of yield
            muniAverages.sort((a, b) => b.avgYield - a.avgYield);

            // Find rank of the target municipality
            const rankIndex = muniAverages.findIndex(item => item.municipality === targetMunicipality);

            return {
                rank: rankIndex + 1,
                total: muniAverages.length
            };
        }

    function getMunicipalityVsLagunaAverage(data, targetMunicipality, targetYear) {
            let muniYields = [];
            let lagunaYields = [];

            data.forEach(entry => {
                if (entry.year == targetYear) {
                    const y = parseFloat(entry.yield);
                    lagunaYields.push(y);
                    if (entry.municipality === targetMunicipality) {
                        muniYields.push(y);
                    }
                }
            });

            if (muniYields.length === 0 || lagunaYields.length === 0) return null;

            const muniAvg = muniYields.reduce((a, b) => a + b, 0) / muniYields.length;
            const lagunaAvg = lagunaYields.reduce((a, b) => a + b, 0) / lagunaYields.length;

            const percentDiff = ((muniAvg - lagunaAvg) / lagunaAvg) * 100;

            return Math.round(percentDiff * 100) / 100; // round to 2 decimals
        }



    function updateMunicipalityKPIs(municipality, year) {
        const rankData = getMunicipalityLagunaRank(window.historicalDataGlobal, municipality, year);
        const percentAbove = getMunicipalityVsLagunaAverage(window.historicalDataGlobal, municipality, year);

        // Labels
        document.getElementById("kpi-label-1").textContent = "Avg Yield";
        document.getElementById("kpi-label-2").textContent = "Laguna Rank";
        document.getElementById("kpi-label-3").textContent = "% Above Laguna Average";

        // Values
        if (rankData) {
            const rankEl = document.getElementById("kpi-value-2");
            const prevRank = parseInt(rankEl.dataset.rank) || rankData.rank;
            rankEl.dataset.rank = rankData.rank;
            animateRankValue(rankEl, prevRank, rankData.rank, rankData.total);
        }

        // Update Rank Display
        if (rankData) {
            const rankEl = document.getElementById("kpi-rank");
            const prevRank = parseInt(rankEl.dataset.rank) || rankData.rank;
            rankEl.dataset.rank = rankData.rank;

            animateRankValue(rankEl, prevRank, rankData.rank, rankData.total);        
        } else {
            document.getElementById("kpi-rank").textContent = "—";
        }

        const kpi_vs_laguna_display = document.getElementById("kpi-vs-laguna");

        const muniYields = window.historicalDataGlobal
            .filter(e => e.year == year && e.municipality === municipality)
            .map(e => parseFloat(e.yield));
        const avgYield = muniYields.reduce((a, b) => a + b, 0) / muniYields.length;

        document.getElementById("kpi-value-1").textContent = `${avgYield.toFixed(2)} t/ha`;

        const displayEl = document.getElementById("kpi-value-3");
        const prev = parseFloat(displayEl.dataset.value) || 0;
        displayEl.dataset.value = percentAbove;
        displayEl.classList.add("kpi-animated");

        animateKpiValue(displayEl, prev, percentAbove, 1500); // Arrow + color handled inside

    }

    // Update KPIs when year is changed
    document.getElementById("year-dropdown-his").addEventListener("change", () => {
            const muni = document.getElementById("municipality-search-his").value;
            if (muni) {
                updateMunicipalityKPIs(muni, parseInt(event.target.value));
            }
        });

    // pampa cute lang
    function animateKpiValue(element, start, end, duration = 1200, suffix = "%") {
            const range = end - start;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const current = start + range * progress;

                const rounded = Math.round(current * 100) / 100;
                const arrow = end > 0 ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>';
                const color = end > 0 ? "green" : "red";

                element.innerHTML = `${arrow} ${Math.abs(rounded)}${suffix}`;
                element.style.color = color;

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            requestAnimationFrame(update);
        }


    function getOrdinalSuffix(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return n + (s[(v - 20) % 10] || s[v] || s[0]);
        }

    function animateRankValue(element, start, end, total, duration = 1200) {
            const range = end - start;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const current = start + range * progress;
                const rounded = Math.round(current);

                element.textContent = `${getOrdinalSuffix(rounded)} of ${total}`;

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            requestAnimationFrame(update);
        }

        let seasonalYieldChart = null;

            function createSeasonalYieldChartForMunicipality(data, targetMunicipality, canvasId = "seasonal-yield-muni-chart") {
                const seasonalData = {};
                const yearSet = new Set();
                const seasonLabels = ["1", "2"]; // Adjust if using "Dry"/"Wet"

                // Filter and group data by season and year
                data.forEach(entry => {
                    if (entry.municipality === targetMunicipality) {
                        const year = parseInt(entry.year);
                        const season = String(entry.season); // assume "1" or "2"
                        const yieldValue = parseFloat(entry.yield);

                        yearSet.add(year);
                        if (!seasonalData[season]) seasonalData[season] = {};
                        if (!seasonalData[season][year]) seasonalData[season][year] = [];
                        seasonalData[season][year].push(yieldValue);
                    }
                });

                const years = Array.from(yearSet).sort((a, b) => a - b);

                const datasets = seasonLabels.map((season, i) => {
                    const dataPoints = years.map(year => {
                        const values = seasonalData[season]?.[year];
                        if (!values || values.length === 0) return 0;
                        return values.reduce((a, b) => a + b, 0) / values.length;
                    });

                    const colors = ["#1b9e77", "#d95f02"]; // green and orange
                    const labels = ["Season 1", "Season 2"];

                    return {
                        label: labels[i],
                        data: dataPoints,
                        backgroundColor: colors[i],
                        borderColor: colors[i],
                        borderWidth: 1
                    };
                });

                const ctx = document.getElementById(canvasId).getContext("2d");

                if (seasonalYieldChart) {
                    seasonalYieldChart.destroy();
                }

                seasonalYieldChart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: years,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: "top"
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: "Yield (t/ha)"
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: "Year"
                                }
                            }
                        }
                    }
                });
            }

    function showLagunaKPIs(data, year) {
            const yieldsByMuni = {};

            data.forEach(entry => {
                if (entry.year == year) {
                    const muni = entry.municipality;
                    if (!yieldsByMuni[muni]) yieldsByMuni[muni] = [];
                    yieldsByMuni[muni].push(parseFloat(entry.yield));
                }
            });

            const averages = Object.entries(yieldsByMuni).map(([muni, yields]) => ({
                municipality: muni,
                avgYield: yields.reduce((a, b) => a + b, 0) / yields.length
            }));

            if (averages.length === 0) return;

            // Laguna-wide average
            const lagunaAvg = averages.reduce((sum, obj) => sum + obj.avgYield, 0) / averages.length;

            // Top & bottom performers
            const top = averages.reduce((a, b) => (a.avgYield > b.avgYield ? a : b));
            const bottom = averages.reduce((a, b) => (a.avgYield < b.avgYield ? a : b));

            // Update KPIs
            document.getElementById("kpi-label-1").textContent = "Laguna Avg Yield";
            document.getElementById("kpi-value-1").textContent = `${lagunaAvg.toFixed(2)} t/ha`;

            document.getElementById("kpi-label-2").textContent = "Top Municipality";
            document.getElementById("kpi-value-2").textContent = `${top.municipality} (${top.avgYield.toFixed(2)} t/ha)`;

            document.getElementById("kpi-label-3").textContent = "Lowest Municipality";
            document.getElementById("kpi-value-3").textContent = `${bottom.municipality} (${bottom.avgYield.toFixed(2)} t/ha)`;
        }

        document.getElementById("clear-search-his").addEventListener("click", () => {
                document.getElementById("municipality-search-his").value = "";
                document.getElementById("clear-search-his").style.display = "none";
                document.getElementById("municipality-dropdown-his").style.display = "none";

                const selectedYear = parseInt(document.getElementById("year-dropdown-his").value);
                showLagunaKPIs(window.historicalDataGlobal, selectedYear);

                // 🔁 Switch chart views back to Laguna
                document.getElementById("laguna-line-chart-container").style.display = "block";
                document.getElementById("municipality-line-chart-container").style.display = "none";
            });


    // Municipality Yield Over The Years Line Chart 
    let municipalityLineChart = null;

    function createLineChartForMunicipality(data, municipality, canvasId = "municipality-line-chart") {
        const yearlyData = {};

        // Group yields by year for the selected municipality
        data.forEach(entry => {
            if (entry.municipality === municipality) {
                const year = parseInt(entry.year);
                const yieldValue = parseFloat(entry.yield);

                if (!yearlyData[year]) yearlyData[year] = [];
                yearlyData[year].push(yieldValue);
            }
        });

        const years = Object.keys(yearlyData).map(Number).sort((a, b) => a - b);
        const averages = years.map(year => {
            const values = yearlyData[year];
            return values.reduce((a, b) => a + b, 0) / values.length;
        });

        // Destroy existing chart if exists
        if (municipalityLineChart) {
            municipalityLineChart.destroy();
        }

        const ctx = document.getElementById(canvasId).getContext("2d");

        municipalityLineChart = new Chart(ctx, {
            type: "line",
            data: {
                labels: years,
                datasets: [{
                    label: `${municipality} Avg Yield (t/ha)`,
                    data: averages,
                    fill: true,
                    borderColor: "green",
                    backgroundColor: "rgba(0,128,0,0.2)",
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: "top"
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: "Yield (t/ha)"
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: "Year"
                        }
                    }
                }
            }
        });

        // 👇 Force it to resize now that the canvas is visible
        setTimeout(() => {
            municipalityLineChart.resize();
        }, 10); // small delay ensures DOM is updated
    }

        


        



    // ZOE CHANGES END HERE
});



</script>
</html>


